generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TABELAS DE USUÁRIOS E CLÍNICAS
// ============================================

model User {
  id        String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id String?
  name      String
  email     String  @unique
  password  String
  role        String   @default("user")
  status      String   @default("active")
  permissions String[] @default([])

  // Google OAuth
  google_id  String? @unique
  avatar_url String?

  // 2FA
  phone              String?
  two_factor_enabled Boolean @default(false)
  two_factor_method  String? // 'whatsapp' | 'totp'
  totp_secret        String?

  // Password Reset
  reset_token         String?   @unique
  reset_token_expires DateTime? @db.Timestamp(6)

  created_at     DateTime        @default(now()) @db.Timestamp(6)
  updated_at     DateTime        @default(now()) @updatedAt @db.Timestamp(6)
  clinic         Clinic?         @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  auditLogs      AuditLog[]
  twoFactorCodes TwoFactorCode[]
  notifications  Notification[]

  @@index([email])
  @@index([clinic_id])
}

model Clinic {
  id                 String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  name               String
  cnpj               String  @unique // CPF (11 digitos) ou CNPJ (14 digitos)
  phone              String
  email              String
  address            String?
  city               String?
  state              String?
  cep                String? @db.VarChar(9)
  z_api_instance     String?
  z_api_token        String?
  z_api_client_token String?

  // SMTP / E-mail
  smtp_host   String?
  smtp_port   Int?     @default(465)
  smtp_user   String?
  smtp_pass   String?
  smtp_from   String?
  smtp_secure Boolean? @default(true)

  plan                 String  @default("basic")
  status               String  @default("active")
  onboarding_completed Boolean @default(false)

  // 2FA Policy
  two_factor_policy String @default("disabled") // 'disabled' | 'optional' | 'required'

  // White-label
  slug String? @unique @db.VarChar(100)

  // Branding
  logo_url          String?
  favicon_url       String?
  logo_display_mode String? @default("logo_name") // logo_name, logo_only, name_only
  primary_color     String? @default("#0EA5E9")
  secondary_color   String? @default("#10B981")
  slogan            String?
  tagline           String?

  // Redes Sociais
  instagram String?
  facebook  String?
  website   String?

  // Horário de Funcionamento
  business_hours Json? // { "monday": { "open": "08:00", "close": "18:00" }, ... }

  // Geolocalização
  latitude  String?
  longitude String?

  // Public Booking
  public_booking_enabled Boolean @default(false)

  created_at       DateTime                @default(now()) @db.Timestamp(6)
  updated_at       DateTime                @default(now()) @updatedAt @db.Timestamp(6)
  users            User[]
  dentists         Dentist[]
  patients         Patient[]
  services         Service[]
  appointments     Appointment[]
  conversations    Conversation[]
  auditLogs        AuditLog[]
  whatsappMessages WhatsAppMessage[]
  subscriptions    Subscription[]
  invoices         Invoice[]
  aiSettings       ClinicAiSettings?
  automations      ClinicAutomation[]
  messageTemplates ClinicMessageTemplate[]

  @@index([cnpj], map: "idx_clinic_cnpj")
  @@index([status], map: "idx_clinic_status")
  @@index([slug], map: "idx_clinic_slug")
}

model Dentist {
  id            String            @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id     String
  name          String
  cro           String
  specialty     String?
  phone         String?
  email         String?
  phone_hash    String?
  commission_rate Decimal?        @default(0) @db.Decimal(5, 2)
  status          String          @default("active")
  created_at      DateTime        @default(now()) @db.Timestamp(6)
  updated_at      DateTime        @default(now()) @updatedAt @db.Timestamp(6)
  clinic          Clinic          @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  schedules       DentistSchedule[]
  prescriptions   Prescription[]
  deleted_at      DateTime?       @db.Timestamp(6)

  @@unique([clinic_id, cro])
  @@index([clinic_id])
  @@index([cro])
  @@index([phone_hash], map: "idx_dentist_phone_hash")
}

model Patient {
  id               String            @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id        String
  name             String
  phone            String
  cpf              String?
  email            String?
  birth_date       DateTime?         @db.Date
  address          String?
  notes            String?
  status           String            @default("active")
  portal_token         String?           @unique @default(dbgenerated("(gen_random_uuid())::text"))
  portal_token_expires DateTime?         @db.Timestamp(6)
  last_visit           DateTime?         @db.Timestamp(6)
  phone_hash       String?
  cpf_hash         String?
  email_hash       String?
  created_at       DateTime          @default(now()) @db.Timestamp(6)
  updated_at       DateTime          @default(now()) @updatedAt @db.Timestamp(6)
  clinic           Clinic            @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  appointments     Appointment[]
  conversations    Conversation[]
  conversationLogs ConversationLog[]
  whatsappMessages WhatsAppMessage[]
  odontograms      Odontogram[]
  prescriptions    Prescription[]
  npsSurveys       NpsSurvey[]
  anamneses        Anamnesis[]
  treatmentPlans   TreatmentPlan[]
  deleted_at       DateTime?         @db.Timestamp(6)

  @@unique([clinic_id, phone], map: "unique_clinic_phone")
  @@index([clinic_id], map: "idx_patient_clinic")
  @@index([phone], map: "idx_patient_phone")
  @@index([phone_hash], map: "idx_patient_phone_hash")
  @@index([cpf_hash], map: "idx_patient_cpf_hash")
  @@index([email_hash], map: "idx_patient_email_hash")
  @@index([clinic_id, status], map: "idx_patient_clinic_status")
  @@index([clinic_id, deleted_at], map: "idx_patient_clinic_deleted")
  @@index([clinic_id, birth_date], map: "idx_patient_clinic_birth_date")
  @@index([clinic_id, status, last_visit], map: "idx_patient_clinic_status_last_visit")
}

model Service {
  id           String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id    String
  name         String
  description  String?
  price        Decimal       @db.Decimal(10, 2)
  duration     Int
  status       String        @default("active")
  created_at   DateTime      @default(now()) @db.Timestamp(6)
  updated_at   DateTime      @default(now()) @updatedAt @db.Timestamp(6)
  clinic       Clinic        @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@unique([clinic_id, name])
  @@index([clinic_id])
}

model Appointment {
  id               String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id        String
  patient_id       String
  dentist_id       String?
  service_id       String
  date             DateTime  @db.Date
  time             String
  duration         Int       @default(30)
  status           String    @default("scheduled")
  notes            String?
  cancel_reason    String?
  cancelled_at     DateTime? @db.Timestamp(6)
  confirmed_at     DateTime? @db.Timestamp(6)
  reminder_sent    Boolean   @default(false)
  reminder_1h_sent Boolean   @default(false)
  created_at       DateTime  @default(now()) @db.Timestamp(6)
  updated_at       DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  clinic           Clinic      @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  patient          Patient     @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  dentist          Dentist?    @relation(fields: [dentist_id], references: [id])
  service          Service     @relation(fields: [service_id], references: [id], onDelete: Cascade)
  npsSurveys       NpsSurvey[]
  deleted_at       DateTime?   @db.Timestamp(6)

  @@index([clinic_id], map: "idx_appointment_clinic")
  @@index([patient_id], map: "idx_appointment_patient")
  @@index([date], map: "idx_appointment_date")
  @@index([status], map: "idx_appointment_status")
  @@index([clinic_id, date], map: "idx_appointment_clinic_date")
  @@index([clinic_id, status], map: "idx_appointment_clinic_status")
  @@index([clinic_id, date, status], map: "idx_appointment_clinic_date_status")
  @@index([dentist_id], map: "idx_appointment_dentist")
  @@index([reminder_sent, date], map: "idx_appointment_reminder_date")
  @@index([clinic_id, dentist_id, date], map: "idx_appointment_clinic_dentist_date")
}

// ============================================
// TABELAS DE CONVERSAÇÃO E MENSAGENS
// ============================================

model Conversation {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id  String
  patient_id String
  messages   String?  @db.Text // encrypted JSON
  created_at DateTime @default(now()) @db.Timestamp(6)
  clinic     Clinic   @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  patient    Patient  @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@index([clinic_id])
  @@index([patient_id])
}

model ConversationLog {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  patient_id String
  message    String
  response   String
  intent     String?
  timestamp  DateTime @default(now()) @db.Timestamp(6)
  patient    Patient  @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@index([patient_id], map: "idx_log_patient")
  @@index([timestamp], map: "idx_log_timestamp")
}

model WhatsAppMessage {
  id          String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id   String
  patient_id  String?
  phone       String
  phone_hash  String?
  message     String   @db.Text
  direction   String // 'incoming' or 'outgoing'
  status      String   @default("sent")
  message_id  String? // Z-API message ID
  raw_payload String?  @db.Text // encrypted JSON
  created_at  DateTime @default(now()) @db.Timestamp(6)
  clinic      Clinic   @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  patient     Patient? @relation(fields: [patient_id], references: [id], onDelete: SetNull)

  @@index([clinic_id])
  @@index([phone_hash], map: "idx_whatsapp_phone_hash")
  @@index([created_at])
  @@index([clinic_id, created_at], map: "idx_whatsapp_clinic_created")
}

// ============================================
// TABELAS DE AUDITORIA
// ============================================

model AuditLog {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id  String?
  user_id    String?
  action     String
  entity     String
  entity_id  String?
  old_values String?  @db.Text // encrypted JSON
  new_values String?  @db.Text // encrypted JSON
  ip_address String?
  user_agent String?
  created_at DateTime @default(now()) @db.Timestamp(6)
  clinic     Clinic?  @relation(fields: [clinic_id], references: [id], onDelete: SetNull)
  user       User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([clinic_id])
  @@index([entity])
  @@index([created_at])
  @@index([clinic_id, created_at], map: "idx_audit_clinic_created")
  @@index([user_id, created_at], map: "idx_audit_user_created")
}

// ============================================
// TABELAS DE PLANOS E ASSINATURAS (SaaS)
// ============================================

model Plan {
  id                     String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name                   String         @unique
  display_name           String         @default("")
  description            String?
  price_monthly          Decimal        @db.Decimal(10, 2)
  price_yearly           Decimal?       @db.Decimal(10, 2)
  max_patients           Int? // null = ilimitado
  max_dentists           Int? // null = ilimitado
  max_appointments_month Int? // null = ilimitado
  max_whatsapp_messages  Int? // null = ilimitado
  features               Json? // Lista de features habilitadas
  ai_enabled             Boolean        @default(false)
  ai_messages_limit      Int? // Limite de mensagens de IA por mês
  priority_support       Boolean        @default(false)
  custom_branding        Boolean        @default(false)
  api_access             Boolean        @default(false)
  status                 String         @default("active")
  sort_order             Int            @default(0)
  created_at             DateTime       @default(now()) @db.Timestamp(6)
  updated_at             DateTime       @default(now()) @updatedAt @db.Timestamp(6)
  subscriptions          Subscription[]

  @@index([status])
  @@index([sort_order])
}

model Subscription {
  id                   String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id            String
  plan_id              String
  billing_cycle        String    @default("monthly") // 'monthly' or 'yearly'
  status               String    @default("active") // 'active', 'cancelled', 'past_due', 'trialing', 'paused'
  current_period_start DateTime  @db.Timestamp(6)
  current_period_end   DateTime  @db.Timestamp(6)
  cancel_at_period_end Boolean   @default(false)
  cancelled_at         DateTime? @db.Timestamp(6)
  trial_start          DateTime? @db.Timestamp(6)
  trial_end            DateTime? @db.Timestamp(6)
  payment_method       String? // 'credit_card', 'pix', 'boleto'
  payment_gateway      String? // 'stripe', 'pagarme', 'asaas'
  external_id          String? // ID na gateway de pagamento
  metadata             Json?
  created_at           DateTime  @default(now()) @db.Timestamp(6)
  updated_at           DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  clinic               Clinic    @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  plan                 Plan      @relation(fields: [plan_id], references: [id])
  invoices             Invoice[]

  @@index([clinic_id])
  @@index([plan_id])
  @@index([status])
  @@index([current_period_end])
  @@index([clinic_id, status], map: "idx_subscription_clinic_status")
}

model Invoice {
  id              String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id       String
  subscription_id String?
  number          String    @unique
  amount          Decimal   @db.Decimal(10, 2)
  discount        Decimal?  @db.Decimal(10, 2)
  tax             Decimal?  @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  status          String    @default("pending") // 'pending', 'paid', 'overdue', 'cancelled', 'refunded'
  due_date        DateTime  @db.Date
  paid_at         DateTime? @db.Timestamp(6)
  payment_method  String?
  payment_gateway String?
  external_id     String? // ID na gateway de pagamento
  invoice_url     String? // URL do boleto ou link de pagamento
  description     String?
  items           Json? // Itens detalhados da fatura
  metadata        Json?

  // NFS-e (Nota Fiscal)
  nfse_id            String? // ID da nota fiscal no provedor
  nfse_pdf_url       String? // URL do PDF da NFS-e
  nfse_status        String? // pending, issued, error, canceled
  nfse_cancel_reason String?
  created_at         DateTime      @default(now()) @db.Timestamp(6)
  updated_at         DateTime      @default(now()) @updatedAt @db.Timestamp(6)
  clinic             Clinic        @relation(fields: [clinic_id], references: [id], onDelete: Cascade)
  subscription       Subscription? @relation(fields: [subscription_id], references: [id], onDelete: SetNull)
  payments           Payment[]

  @@index([clinic_id])
  @@index([subscription_id])
  @@index([status])
  @@index([due_date])
  @@index([number])
  @@index([clinic_id, status], map: "idx_invoice_clinic_status")
  @@index([clinic_id, due_date], map: "idx_invoice_clinic_due_date")
}

model Payment {
  id                 String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  invoice_id         String
  gateway            String // stripe, asaas
  gateway_payment_id String?
  method             String // credit_card, pix, boleto
  amount             Decimal   @db.Decimal(10, 2)
  status             String    @default("pending") // pending, confirmed, failed, refunded
  paid_at            DateTime? @db.Timestamp(6)
  metadata           Json?
  created_at         DateTime  @default(now()) @db.Timestamp(6)
  invoice            Invoice   @relation(fields: [invoice_id], references: [id], onDelete: Cascade)

  @@index([invoice_id])
  @@index([gateway_payment_id])
  @@index([status])
}

model Coupon {
  id               String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  code             String    @unique
  discount_percent Int
  discount_months  Int       @default(1)
  max_uses         Int?
  current_uses     Int       @default(0)
  valid_until      DateTime? @db.Timestamp(6)
  is_active        Boolean   @default(true)
  created_at       DateTime  @default(now()) @db.Timestamp(6)

  @@index([code])
  @@index([is_active])
}

// ============================================
// TABELAS DE CONFIGURAÇÕES DA CLÍNICA
// ============================================

model ClinicAiSettings {
  id                    String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id             String   @unique
  ai_enabled            Boolean  @default(true)
  ai_provider           String   @default("anthropic") // anthropic, openai, google
  ai_api_key            String? // Chave API do provedor (encriptada)
  ai_model              String   @default("claude-3-5-haiku-20241022")
  ai_temperature        Decimal  @default(0.7) @db.Decimal(2, 1)
  max_tokens            Int      @default(800)
  assistant_name        String   @default("Sofia")
  assistant_personality String? // Descrição da personalidade
  welcome_message       String?
  fallback_message      String?
  out_of_hours_message  String?
  transfer_keywords     String[] // Palavras que acionam transferência para humano
  blocked_topics        String[] // Tópicos que a IA não deve responder
  custom_instructions   String? // Instruções adicionais para a IA
  context_messages      Int      @default(10) // Quantas mensagens de contexto enviar
  auto_schedule         Boolean  @default(false) // IA pode agendar automaticamente
  auto_confirm          Boolean  @default(false) // IA pode confirmar automaticamente
  auto_cancel           Boolean  @default(false) // IA pode cancelar automaticamente
  notify_on_transfer    Boolean  @default(true)
  working_hours_only    Boolean  @default(false) // IA só responde no horário comercial

  // Mensagens Interativas
  use_welcome_menu         Boolean @default(false) // Lista de opções no primeiro contato
  use_confirmation_buttons Boolean @default(false) // Botões para confirmar consulta
  use_timeslot_list        Boolean @default(false) // Lista de horários selecionável
  use_satisfaction_poll    Boolean @default(false) // Pesquisa de satisfação pós-consulta
  use_send_location        Boolean @default(false) // Enviar localização da clínica

  // Dentista via WhatsApp
  dentist_ai_enabled Boolean @default(false) // Dentistas podem interagir com IA via WhatsApp

  // Lembretes automáticos
  reminder_enabled     Boolean @default(true) // Ativar lembretes automáticos
  reminder_24h         Boolean @default(true) // Lembrete 24h antes
  reminder_1h          Boolean @default(true) // Lembrete 1h antes
  reminder_message_24h String? // Mensagem personalizada 24h
  reminder_message_1h  String? // Mensagem personalizada 1h

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamp(6)
  clinic     Clinic   @relation(fields: [clinic_id], references: [id], onDelete: Cascade)

  @@index([clinic_id])
}

model ClinicAutomation {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id      String
  name           String
  type           String // 'reminder', 'confirmation', 'follow_up', 'birthday', 'reactivation', 'custom'
  trigger_type   String // 'scheduled', 'event', 'condition'
  trigger_config Json // Configuração do trigger (horário, evento, condição)
  action_type    String // 'whatsapp', 'email', 'sms', 'webhook'
  action_config  Json // Configuração da ação (template, destinatário, etc)
  is_active      Boolean   @default(true)
  last_run_at    DateTime? @db.Timestamp(6)
  next_run_at    DateTime? @db.Timestamp(6)
  run_count      Int       @default(0)
  error_count    Int       @default(0)
  last_error     String?
  created_at     DateTime  @default(now()) @db.Timestamp(6)
  updated_at     DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  clinic         Clinic    @relation(fields: [clinic_id], references: [id], onDelete: Cascade)

  @@index([clinic_id])
  @@index([type])
  @@index([is_active])
  @@index([next_run_at])
}

model ClinicMessageTemplate {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id  String
  name       String
  type       String // 'reminder', 'confirmation', 'cancellation', 'welcome', 'follow_up', 'birthday', 'custom'
  channel    String   @default("whatsapp") // 'whatsapp', 'email', 'sms'
  subject    String? // Para email
  content    String // Conteúdo com placeholders: {{patient_name}}, {{appointment_date}}, etc
  variables  String[] // Lista de variáveis disponíveis
  is_active  Boolean  @default(true)
  is_default Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamp(6)
  clinic     Clinic   @relation(fields: [clinic_id], references: [id], onDelete: Cascade)

  @@unique([clinic_id, name])
  @@index([clinic_id])
  @@index([type])
  @@index([is_active])
}

// ============================================
// TABELAS DE HORÁRIOS DOS DENTISTAS
// ============================================

model DentistSchedule {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  dentist_id    String
  day_of_week   Int // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
  start_time    String // "08:00"
  end_time      String // "18:00"
  break_start   String? // "12:00"
  break_end     String? // "13:00"
  slot_duration Int       @default(30) // Duração de cada slot em minutos
  is_active     Boolean   @default(true)
  valid_from    DateTime? @db.Date
  valid_until   DateTime? @db.Date
  created_at    DateTime  @default(now()) @db.Timestamp(6)
  updated_at    DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  dentist       Dentist   @relation(fields: [dentist_id], references: [id], onDelete: Cascade)

  @@unique([dentist_id, day_of_week, valid_from])
  @@index([dentist_id])
  @@index([day_of_week])
  @@index([is_active])
}

// ============================================
// CONFIGURAÇÕES GLOBAIS DO SISTEMA
// ============================================

model SystemConfig {
  id          String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  key         String   @unique
  value       String
  type        String   @default("string") // 'string', 'number', 'boolean', 'json'
  description String?
  is_public   Boolean  @default(false) // Se pode ser exposto via API pública
  is_editable Boolean  @default(true) // Se pode ser editado via admin
  category    String? // Categoria para agrupamento (ex: 'billing', 'ai', 'notifications')
  created_at  DateTime @default(now()) @db.Timestamp(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@index([key])
  @@index([category])
  @@index([is_public])
}

// ============================================
// TABELAS DE AUTENTICAÇÃO 2FA
// ============================================

model TwoFactorCode {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id    String
  code       String
  method     String // 'whatsapp' | 'email'
  expires_at DateTime @db.Timestamp(6)
  used       Boolean  @default(false)
  attempts   Int      @default(0)
  created_at DateTime @default(now()) @db.Timestamp(6)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([expires_at])
}

// ============================================
// TABELAS DE NOTIFICAÇÕES
// ============================================

model Notification {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id    String
  clinic_id  String?
  type       String // appointment_reminder, payment_received, plan_expiring, new_appointment, etc.
  title      String
  body       String
  read       Boolean  @default(false)
  data       Json? // metadata (link, entity_id, entity_type, etc.)
  created_at DateTime @default(now()) @db.Timestamp(6)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, read])
  @@index([clinic_id])
  @@index([created_at])
  @@index([user_id, created_at], map: "idx_notification_user_created")
}

// ============================================
// TABELAS DE ODONTOGRAMA
// ============================================

enum DentitionType {
  PERMANENT
  DECIDUOUS
  MIXED
}

enum ToothSurface {
  WHOLE
  M  // Mesial
  D  // Distal
  OI // Oclusal/Incisal
  VB // Vestibular/Bucal
  LP // Lingual/Palatal
}

enum OdontogramEntryType {
  FINDING
  PROCEDURE
  NOTE
}

enum TreatmentPlanItemStatus {
  PLANNED
  IN_PROGRESS
  DONE
  CANCELLED
}

model Odontogram {
  id              String            @id @default(dbgenerated("(gen_random_uuid())::text"))
  patient_id      String
  clinic_id       String
  dentition_type  DentitionType     @default(PERMANENT)
  created_by      String?
  notes           String?
  created_at      DateTime          @default(now()) @db.Timestamp(6)
  updated_at      DateTime          @default(now()) @updatedAt @db.Timestamp(6)
  patient         Patient           @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  entries         OdontogramEntry[]
  treatmentPlans  TreatmentPlan[]

  @@index([patient_id])
  @@index([clinic_id])
}

model OdontogramEntry {
  id                     String               @id @default(dbgenerated("(gen_random_uuid())::text"))
  odontogram_id          String
  tooth_number           Int // 11-48 permanent (FDI), 51-85 deciduous
  entry_type             OdontogramEntryType
  status_code            String // Generic codes: CARIES_SUSPECTED, RESTORATION_COMPOSITE, EXTRACTION, etc.
  surfaces               ToothSurface[]       @default([WHOLE])
  notes                  String?
  created_by             String?
  superseded_by          String? // FK to new entry that corrects this one
  superseded_at          DateTime?            @db.Timestamp(6)
  treatment_plan_item_id String?
  created_at             DateTime             @default(now()) @db.Timestamp(6)
  odontogram             Odontogram           @relation(fields: [odontogram_id], references: [id], onDelete: Cascade)
  treatmentPlanItem      TreatmentPlanItem?   @relation(fields: [treatment_plan_item_id], references: [id], onDelete: SetNull)
  supersededByEntry      OdontogramEntry?     @relation("EntrySupersede", fields: [superseded_by], references: [id])
  supersedes             OdontogramEntry[]    @relation("EntrySupersede")

  @@index([odontogram_id])
  @@index([tooth_number])
  @@index([odontogram_id, tooth_number, created_at(sort: Desc)])
  @@index([superseded_at])
}

model OdontogramLegendItem {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  clinic_id  String
  code       String // Matches OdontogramEntry.status_code
  label      String
  color      String // Hex color
  icon       String? // Optional icon name
  category   String   @default("general") // finding, procedure, general
  sort_order Int      @default(0)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@unique([clinic_id, code])
  @@index([clinic_id])
  @@index([is_active])
}

// ============================================
// TABELAS DE RECEITUÁRIO E DOCUMENTOS
// ============================================

model Prescription {
  id         String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  patient_id String
  dentist_id String
  clinic_id  String
  type       String // prescription, certificate, referral
  content    String  @db.Text // encrypted JSON: { medications: [...] } ou { text: "..." }
  pdf_url    String?
  sent_at    DateTime? @db.Timestamp(6)
  sent_via   String? // whatsapp, email
  created_at DateTime  @default(now()) @db.Timestamp(6)
  patient    Patient   @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  dentist    Dentist   @relation(fields: [dentist_id], references: [id])
  deleted_at DateTime? @db.Timestamp(6)

  @@index([patient_id])
  @@index([dentist_id])
  @@index([clinic_id])
}

// ============================================
// TABELAS DE NPS E PESQUISA DE SATISFAÇÃO
// ============================================

model NpsSurvey {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  patient_id     String
  clinic_id      String
  appointment_id String?
  score          Int? // 0-10
  feedback       String?
  sent_at        DateTime  @default(now()) @db.Timestamp(6)
  answered_at    DateTime? @db.Timestamp(6)
  patient        Patient      @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  appointment    Appointment? @relation(fields: [appointment_id], references: [id], onDelete: SetNull)

  @@index([clinic_id])
  @@index([patient_id])
  @@index([appointment_id])
  @@index([sent_at])
}

// ============================================
// ANAMNESE (HISTÓRICO MÉDICO DO PACIENTE)
// ============================================

model Anamnesis {
  id                  String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  patient_id          String
  clinic_id           String
  filled_by_id        String?
  allergies           String?  @db.Text @default("[]")
  medications         String?  @db.Text @default("[]")
  conditions          String?  @db.Text @default("[]")
  surgeries           String?  @db.Text
  habits              String?  @db.Text
  risk_classification String?
  contraindications   String?  @db.Text @default("[]")
  alerts              String?  @db.Text @default("[]")
  warnings            String?  @db.Text @default("[]")
  ai_notes            String?  @db.Text
  ai_recommendations  String?  @db.Text
  raw_answers         String?  @db.Text
  created_at          DateTime @default(now()) @db.Timestamp(6)
  updated_at          DateTime @default(now()) @updatedAt @db.Timestamp(6)
  patient             Patient  @relation(fields: [patient_id], references: [id], onDelete: Cascade)

  @@index([patient_id])
  @@index([clinic_id])
}

// ============================================
// PLANOS DE TRATAMENTO
// ============================================

model TreatmentPlan {
  id              String              @id @default(dbgenerated("(gen_random_uuid())::text"))
  patient_id      String
  clinic_id       String
  created_by      String?
  status          String              @default("pending") // pending, in_progress, completed, cancelled
  patient_summary String?
  phases          String?  @db.Text
  total_cost      Decimal?            @db.Decimal(10, 2)
  total_sessions  Int?
  recommendations String?
  odontogram_id   String?
  notes           String?
  created_at      DateTime            @default(now()) @db.Timestamp(6)
  updated_at      DateTime            @default(now()) @updatedAt @db.Timestamp(6)
  patient         Patient             @relation(fields: [patient_id], references: [id], onDelete: Cascade)
  odontogram      Odontogram?         @relation(fields: [odontogram_id], references: [id], onDelete: SetNull)
  items           TreatmentPlanItem[]

  @@index([patient_id])
  @@index([clinic_id])
  @@index([status])
}

model TreatmentPlanItem {
  id                   String                  @id @default(dbgenerated("(gen_random_uuid())::text"))
  treatment_plan_id    String
  tooth_number         Int?
  procedure_code       String
  description          String?
  status               TreatmentPlanItemStatus @default(PLANNED)
  estimated_cost       Decimal?                @db.Decimal(10, 2)
  actual_cost          Decimal?                @db.Decimal(10, 2)
  notes                String?
  sort_order           Int                     @default(0)
  completed_at         DateTime?               @db.Timestamp(6)
  completed_by         String?
  created_at           DateTime                @default(now()) @db.Timestamp(6)
  updated_at           DateTime                @default(now()) @updatedAt @db.Timestamp(6)
  treatmentPlan        TreatmentPlan           @relation(fields: [treatment_plan_id], references: [id], onDelete: Cascade)
  odontogramEntries    OdontogramEntry[]

  @@index([treatment_plan_id])
  @@index([status])
}
